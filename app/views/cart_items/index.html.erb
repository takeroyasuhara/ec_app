<% provide(:title, 'All Cart Items') %>
<h1>カート内商品一覧</h1>

<% if @cart_items.count != 0 %>

  <h5>
    <ul>
    <% sum = 0 %>
    <% @products.each do |product| %>
      <li>
        <% cart_item = @cart_items.find_by(product_id: product.id) %>
        <%= link_to product.title, product %>

        価格: <%= product.price %>円
        <% if cart_item.asking_quantity <= product.stock_quantity %>
        購入希望数: <%= cart_item.asking_quantity %>個
          小計: <%= product.price * cart_item.asking_quantity %>円
          <% sum += product.price * cart_item.asking_quantity%>
        <% elsif cart_item.asking_quantity > product.stock_quantity && product.stock_quantity != 0%>
        <font color=Red>在庫が購入希望数（<%= cart_item.asking_quantity %>個）以下です。現在<%= product.stock_quantity %>個まで購入できます</font>
        <% else product.stock_quantity == 0%>
        <font color=Red>在庫切れです。</font>
        <% end %>

        <%= link_to "delete", cart_item_path(cart_item.id),
         method: :delete, data: { confirm: "You sure?" } %>

        <% if product.stock_quantity !=0 %>
          <%= form_for(cart_item) do |f| %>
          <%= f.hidden_field :lock_version %>

          <%= f.text_field :asking_quantity, class: 'form-control'%>
          <%= f.submit "購入希望数を変更する", class: "btn btn-large btn-primary" %>
        <% end %>

      <% end %>

      </li>
      <% end %>
    </ul>
    合計: <%= sum %>円
    <% if sum != 0%>
      <%= link_to "注文確定画面に進む", confirmation_path %>
    <% end %>
  </h5>
<% else @cart_items.count == 0 %>
  You don't have any items. Please check <%= link_to "Our items", root_url %>
<% end %>
